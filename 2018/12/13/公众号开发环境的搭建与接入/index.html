<!DOCTYPE html>
<html lang="z">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    
    <title>微信公众号的开发环境搭建与接入 | 爱听音乐的狗</title>
    <meta name="renderer" content="webkit">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <meta name="description" content="士不可以不弘毅，任重而道远">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="微信公众号的开发环境搭建与接入 | 爱听音乐的狗">
    <meta name="twitter:description" content="士不可以不弘毅，任重而道远">

    <meta property="og:type" content="article">
    <meta property="og:title" content="微信公众号的开发环境搭建与接入 | 爱听音乐的狗">
    <meta property="og:description" content="士不可以不弘毅，任重而道远">

    
    <meta name="author" content="汪汪神">
    
    <link rel="stylesheet" href="/css/vno.css">
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css">

    
    <link rel="icon" href="/images/avatar-small.png">
    

    <meta name="generator" content="hexo"/>
    

    <link rel="canonical" href="http://yoursite.com/2018/12/13/公众号开发环境的搭建与接入/"/>

                 
</head>

<body class="home-template no-js">
    <script src="//cdn.bootcss.com/jquery/2.1.4/jquery.min.js"></script>
    <script src="/js/main.js"></script>
    <span class="mobile btn-mobile-menu">
        <i class="fa fa-list btn-mobile-menu__icon"></i>
        <i class="fa fa-angle-up btn-mobile-close__icon hidden"></i>
    </span>

    
<header class="panel-cover panel-cover--collapsed" style="background-image: url(/images/background-cover.jpg)">
  <div class="panel-main">
    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">

        <a href="/" title="前往 爱听音乐的狗 的主页"><img src="/images/avatar.jpg" width="80" alt="爱听音乐的狗 logo" class="panel-cover__logo logo"></a>
        <h1 class="panel-cover__title panel-title"><a href="/" title="link to homepage for 爱听音乐的狗">爱听音乐的狗</a></h1>
        
        <span class="panel-cover__subtitle panel-subtitle">有趣，古怪，奇异</span>
        
        <hr class="panel-cover__divider">
        <p class="panel-cover__description">士不可以不弘毅，任重而道远</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary">

        <div class="navigation-wrapper">
          <div>
          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
              <li class="navigation__item"><a href="/#blog" title="访问博客" class="blog-button">文字阁</a></li>
            
            </ul>
          </nav>
          </div>
          <div>
          <nav class="cover-navigation navigation--social">
  <ul class="navigation">

  <!-- Weibo-->
  

  <!-- Github -->
  

<!-- Stack Overflow -->
        

  <!-- Google Plus -->
  

<!-- Facebook -->

  
<!-- Twitter -->

  



  </ul>
</nav>

          </div>
        </div>

      </div>

    </div>

    <div class="panel-cover--overlay cover-origin"></div>
  </div> 
</header>

    <div class="content-wrapper">
        <div class="content-wrapper__inner">
            <article class="post-container post-container--single">

  <header class="post-header">
    <div class="post-meta">
      <time datetime="2018-12-12T16:00:00.000Z" class="post-list__meta--date date">2018-12-13</time> &#8226; <span class="post-meta__tags tags">于 
  <a class="tag-link" href="/tags/公众号开发/">公众号开发</a>
 </span>
      <span class="page-pv">
       阅读 <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span>
      </span> 
   
    </div>
    <h1 class="post-title">微信公众号的开发环境搭建与接入</h1>
  </header>

  <section class="post">
    <h3 id="开发环境的搭建"><a href="#开发环境的搭建" class="headerlink" title="开发环境的搭建"></a>开发环境的搭建</h3><p>1、进入<a href="https://www.ngrok.cc/" target="_blank" rel="noopener">Ngrok官网</a>，下载客户端</p>
<p><img src="/2018/12/13/公众号开发环境的搭建与接入/1.png" alt="客户端的下载"></p>
<p>2、选择需要下载的版本并解压</p>
<p><img src="/2018/12/13/公众号开发环境的搭建与接入/2.png" alt="客户端版本选择"></p>
<p>3、注册ngrok账号并登陆，在隧道管理页进行隧道的开通</p>
<p><img src="/2018/12/13/公众号开发环境的搭建与接入/3.png" alt="购买服务器"></p>
<p>4、 填写隧道信息</p>
<p><img src="/2018/12/13/公众号开发环境的搭建与接入/4.png" alt="信息填写"></p>
<p>5、隧道连接</p>
<p>在开通隧道之后会产生一个隧道id，可以在终端中根据隧道id进行连接，当终端出现在线时，代表连接成功，这时其他人就可以通过域名来连接到本地端口</p>
<p><img src="/2018/12/13/公众号开发环境的搭建与接入/5.png" alt="连接"></p>
<h3 id="开发接入"><a href="#开发接入" class="headerlink" title="开发接入"></a>开发接入</h3><p>1、接口测试号申请</p>
<p>在微信公众号平台技术文档中选择  –&gt;  “开始开发” –&gt; “接口测试号申请” –&gt; “进入微信公众账号测试号申请系统”</p>
<p><img src="/2018/12/13/公众号开发环境的搭建与接入/6.png" alt="测试号申请入口"></p>
<p>使用自己的微信账号进行扫描,进入测试号管理页面</p>
<p><img src="/2018/12/13/公众号开发环境的搭建与接入/7.png" alt="测试号管理"></p>
<p>2、扫描二维码关注公众号</p>
<p>在测试号管理页面下方有测试号二维码扫面，使用微信扫码即可关注测试公众号</p>
<p><img src="/2018/12/13/公众号开发环境的搭建与接入/8.png" alt="测试公众号"></p>
<p>3、接入</p>
<p>在微信公众平台技术文档中有很详细的<a href="https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1421135319" target="_blank" rel="noopener">接入指南</a></p>
<p>接入第一步：填写服务器配置</p>
<p>在测试号管理页可以进行接口信息的配置，填写服务器地址（URL）、Token，其中URL是开发者用来接收微信消息和事件的接口URL。Token可由开发者可以任意填写，用作生成签名（该Token会和接口URL中包含的Token进行比对，从而验证安全性），这时候点提交，肯定是配置失败</p>
<p><img src="/2018/12/13/公众号开发环境的搭建与接入/9.png" alt="配置填写"></p>
<p>第二步：验证消息的确来自微信服务器</p>
<p>开发者提交信息后，微信服务器将发送GET请求到填写的服务器地址URL上，GET请求携带参数包括”signature”、”timestamp”、”nonce”、”echostr”，通过对signature进行校验，确认此次GET请求来自微信服务器就返回”echostr”参数内容，接入就生效。</p>
<p>校验方式为：将token、timestamp、nonce三个参数进行字典序排序 ，然后三个参数字符串拼接成一个字符串进行sha1加密 ，最后开发者获得加密后的字符串可与signature对比，相同则标识该请求来源于微信</p>
<p>校验signature的Java示例代码:</p>
<p>创建WxServlet 继承自 HttpServlet，重写doGet方法，在方法中调用WxService的check方法校验signature，根据提供的校验方法校验成功，就返回”echostr”参数内容</p>
<pre><code>@WebServlet(&quot;/wx&quot;)
public class WxServlet extends HttpServlet {

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        /**
         * signature    微信加密签名，signature结合了开发者填写的token参数和请求中的timestamp参数、nonce参数。
         * timestamp    时间戳
         * nonce        随机数
         * echostr        随机字符串
         */
        String signature = req.getParameter(&quot;signature&quot;);
        String timestamp = req.getParameter(&quot;timestamp&quot;);
        String nonce = req.getParameter(&quot;nonce&quot;);
        String echostr = req.getParameter(&quot;echostr&quot;);
        // 检验signature
        if (WxService.check(timestamp, nonce, signature)) {
            // 校验成功，原样返回echostr参数内容
            System.out.println(&quot;校验成功&quot;);
            PrintWriter writer = resp.getWriter();
            writer.print(echostr);
            writer.flush();
            writer.close();
        } else {
            System.out.println(&quot;校验失败&quot;);
        }
    }
</code></pre><p>}</p>
<p>创建 WxService，提供校验的方法以及加密方式，常量TOKEN为微信接口配置信息页填写的Token</p>
<pre><code>public class WxService {

    // 微信公众号配置的TOKEN
    private static final String TOKEN = &quot;hjwx&quot;;
    /**
     * 微信接入验证
     * @param timestamp 时间戳
     * @param nonce     随机数
     * @param signature 微信加密签名
     * @return
     */
    public static boolean check(String timestamp, String nonce, String signature) {
        /**
         * 1）将token、timestamp、nonce三个参数进行字典序排序
         * 2）将三个参数字符串拼接成一个字符串进行sha1加密
         * 3）开发者获得加密后的字符串可与signature对比，标识该请求来源于微信
         */
        String[] strs = new String[]{TOKEN, timestamp, nonce};
        Arrays.sort(strs);
        String str = strs[0] + strs[1] + strs[2];
        String mySignature = sha1(str);
        return mySignature.equalsIgnoreCase(signature);
    }

    /**
     * 进行sha1加密
     * @param str
     * @return
     */
    private static String sha1(String str) {

        try {
            //获取加密对象
            MessageDigest messageD = MessageDigest.getInstance(&quot;sha1&quot;);
            //加密
            byte[] digest = messageD.digest(str.getBytes());
            //处理加密结果
            char[] chars = {&apos;0&apos;,&apos;1&apos;,&apos;2&apos;,&apos;3&apos;,&apos;4&apos;,&apos;5&apos;,&apos;6&apos;,&apos;7&apos;,&apos;8&apos;,&apos;9&apos;,&apos;a&apos;,&apos;b&apos;,&apos;c&apos;,&apos;d&apos;,&apos;e&apos;,&apos;f&apos;};
            StringBuilder stringBuilder = new StringBuilder();
            for (byte b:digest) {
                stringBuilder.append(chars[(b&gt;&gt;4) &amp; 15]);
                stringBuilder.append(chars[b &amp; 15]);
            }
            return stringBuilder.toString();
        } catch (Exception e) {
            e.printStackTrace();
        }
        return null;
    }

}
</code></pre><p>在Tomcat上运行Java示例代码，此时需要将Tomcat端口改为8080，因为在做内网穿透时，配置的本地端口是localhost:8080，所以外部访问的域名相当于访问localhost:8080，再次点击微信测试号管理页的接口配置信息提交按钮，配置就会成功了。</p>
<blockquote>
<p>提示<br>Ngrok提供的免费域名不太稳定，如果测试号管理业显示”配置失败”，但是Java代码中验证成功并在控制台打印了”校验成功”，此时代码是没有任何问题的，原因出在Ngrok的域名所导致的不稳定；多提交几次就不会存在问题</p>
</blockquote>

  </section>

</article>

<section class="read-more">
           
    
               
            <div class="read-more-item">
                <span class="read-more-item-dim">最近的文章</span>
                <h2 class="post-list__post-title post-title"><a href="/2019/05/27/基础控制器的构建与设备方向的控制/" title="基础控制器的构建与设备方向的控制">基础控制器的构建与设备方向的控制</a></h2>
                <p class="excerpt">
                
                涉及知识点1、基于UIViewController构建基础控制器2、基于UINavigationController构建导航控制器并添加Pop手势3、基于UITabBarController构建主控制器4、指定控制器可进行设备方向翻转
具体实现1、基于UIViewController构建基础控制器

                &hellip;
                </p>
                <div class="post-list__meta"><time datetime="2019-05-26T16:00:00.000Z" class="post-list__meta--date date">2019-05-27</time> &#8226; <span class="post-list__meta--tags tags">于 
  <a class="tag-link" href="/tags/Swift/">Swift</a>
</span><a class="btn-border-small" href="/2019/05/27/基础控制器的构建与设备方向的控制/">继续阅读</a></div>
                           
            </div>
        
        
               
            <div class="read-more-item">
                <span class="read-more-item-dim">更早的文章</span>
                <h2 class="post-list__post-title post-title"><a href="/2018/12/13/微信公众号获取Access_token与自定义菜单创建/" title="微信公众号获取Access_token与自定义菜单创建">微信公众号获取Access_token与自定义菜单创建</a></h2>
                <p class="excerpt">
                
                获取access_token获取access_token微信公众号官方文档
1、access_token简单说明
access_token是公众号的全局唯一接口调用凭据，公众号调用各接口时都需使用access_token，获取到access_token之后应将值进行保存，而不是每次都调用接口进行获取
                &hellip;
                </p>
                <div class="post-list__meta"><time datetime="2018-12-12T16:00:00.000Z" class="post-list__meta--date date">2018-12-13</time> &#8226; <span class="post-list__meta--tags tags">于 
  <a class="tag-link" href="/tags/公众号开发/">公众号开发</a>
</span><a class="btn-border-small" href="/2018/12/13/微信公众号获取Access_token与自定义菜单创建/">继续阅读</a></div>
                       
            </div>
        
     
   
   
  
</section>

  

            <footer class="footer">
    <span class="footer__copyright">
        &copy; 2021 汪汪神 - 本站点采用 <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>
       
    </span>
    <span class="footer__copyright">
             - 基于 <a href="http://hexo.io">Hexo</a> 搭建，使用 <a href="https://github.com/monniya/hexo-theme-new-vno ">new-vno</a> 主题，由<a href="https://monniya.com ">@Monniya</a> 修改自 <a href="https://github.com/lenbo-ma/hexo-theme-vno" target="_blank">Vno</a>, 原创出自<a href="http://github.com/onevcat/vno" target="_blank">onevcat</a>
         </span>
       
    
    
</footer>


        </div>
    </div>

     
<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	ga('create', 'UA-78918255-1', 'auto');
	ga('send', 'pageview');
</script>

    
    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?9cdad07c755fa23f6aced510c6760e87";
            var s = document.getElementsByTagName("script")[0]; 
            s.parentNode.insertBefore(hm, s);
        })();
    </script>



    <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    
    
</body>
</html>
